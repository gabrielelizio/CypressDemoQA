# Copilot Instructions for CypressDemoQA

## Project Overview
This is a modern Cypress automation framework for DemoQA testing with BDD/Cucumber, featuring modular step definitions and comprehensive API/UI test coverage. The project uses **Cypress 15** with ESBuild preprocessor for performance.

## Architecture Patterns

### Modular Step Definitions Structure
```
cypress/support/step_definitions/
├── api/bookstore.steps.js          # API operations with shared state
├── shared/common.steps.js          # Navigation & reusable UI steps  
└── ui/
    ├── forms/practice-form.steps.js    # Form-specific interactions
    ├── interactions/                   # Drag-drop, progress bars
    └── navigation/                     # Tables, windows, routing
```

**Key Pattern**: Each domain has isolated step definitions. API steps maintain shared `userData` objects across scenarios. UI steps use robust element detection with fallback strategies.

### Robust Element Interaction Pattern
```javascript
// Standard pattern for uncertain UI states
cy.get('body').then(($body) => {
  if ($body.find('.expected-element').length > 0) {
    // Primary action
    cy.get('.expected-element').click();
  } else {
    // Fallback strategy
    cy.log('Fallback: expected element not found');
  }
});
```

### Tab-Aware UI Interactions
DemoQA pages often have hidden tabs. Always check for tab structures:
```javascript
// Handle tabs before interacting with content
if ($body.find('.nav-tabs').length > 0) {
  cy.get('.nav-tabs .nav-link').first().click();
  cy.wait(1000);
}
```

## Critical Commands & Workflows

### Test Execution by Tags
```bash
npm run test:api          # @api tagged scenarios
npm run test:ui           # @ui tagged scenarios  
npm run test:practice-form # Specific feature tests
npm run test:all          # Complete suite
npm run report            # Generate HTML reports
```

### Configuration Dependencies
- **ESBuild Integration**: Uses `@bahmutov/cypress-esbuild-preprocessor` with Cucumber plugin
- **JSON Reports**: Configure via `.cypress-cucumber-preprocessorrc.json` → `cypress/reports/cucumber-json/results.json`
- **HTML Reports**: Generated by `generate-report.js` using `multiple-cucumber-html-reporter`

## Project-Specific Conventions

### API Testing with State Management
```javascript
// Shared variables pattern in API steps
let userData = {};

Given('I create a new user with username {string}', (username) => {
  cy.request('POST', '/Account/v1/User', { userName: username })
    .then((response) => {
      userData.userId = response.body.userID; // Preserve state
    });
});
```

### Custom Commands for Resilience
- `cy.forceClick()` - Override element interaction issues
- `cy.waitForElement(selector, timeout)` - Explicit waits
- `cy.navigateWithRetry(url, maxRetries)` - Handle flaky navigation
- `cy.loginAPI()` - Session-based authentication with `cy.session()`

### Error-Tolerant Validation Strategy
For dynamic content (tables, lists), validate by absence rather than exact counts:
```javascript
// ❌ Brittle: .should('have.length', 0)
// ✅ Robust: Check for meaningful content absence
const rowsWithContent = $rows.filter((index, row) => {
  return Cypress.$(row).find('.rt-td').filter((i, td) => {
    const text = Cypress.$(td).text().trim();
    return text !== '' && text !== ' ' && text !== '\u00a0';
  }).length > 0;
});
```

## Integration Points

### BDD Feature Organization
- **API Features**: `features/api/` - Complete user/bookstore workflows
- **UI Features**: `features/ui/` - Domain-specific scenarios (forms, tables, interactions)
- **Tag Strategy**: Combine `@api/@ui` with `@feature-name` for granular execution

### Report Generation Flow
1. Tests generate JSON → `cypress/reports/cucumber-json/results.json`
2. `generate-report.js` converts JSON → HTML reports with metadata
3. **Important**: JSON files are overwritten on each run (not cumulative)

### DemoQA Site Specifics
- **Base URL**: `https://demoqa.com` (configured in `cypress.config.js`)
- **Navigation Pattern**: Sidebar with `.left-pannel` → menu → submenu clicks
- **Dynamic Content**: Tables show default records, use delete button presence for validation
- **Tab Components**: Many pages use Bootstrap tabs requiring activation before interaction

## Debugging Guidelines

### When Tests Fail
1. **Check screenshots**: Auto-generated in `cypress/screenshots/`
2. **Review logs**: Extensive `cy.log()` statements throughout step definitions
3. **Validate selectors**: DemoQA elements may be in hidden tabs or dynamic containers
4. **Network issues**: Use `cy.navigateWithRetry()` for flaky page loads

### Common Gotchas
- **Element visibility**: Always check parent containers for `display: none`
- **Timing**: DemoQA has ads/external resources that affect load times
- **State cleanup**: API tests reuse usernames, handle 406 responses gracefully
- **Report generation**: Run `npm run report` after test execution for HTML output
